<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EACGo</title>
</head>
<body>

<div id="background"></div>

<style>
    #background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: black;
        z-index: 1;
    }
</style>

<canvas id="canvas"></canvas>

<style>
    #canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 2;
    }
</style>

<script src="$GODOT_URL"></script>
<script>
    var engine = new Engine($GODOT_CONFIG);
    engine.startGame();
</script>

<canvas id="qr-canvas"></canvas>
<video id="qr-video"></video>

<style>
    #qr-video, #qr-canvas {
        position: fixed;
        top: 0;
        left: 0;
        z-index: -10;
    }

    #qr-canvas {
        transform: scaleX(-1);
    }
</style>

<script>
    window.godotFunctions = {};
    window.externalator = {
        video : document.getElementById("qr-video"),
        addGodotFunction: (n,f) => {
            window.godotFunctions[n] = f;
        }
    }
</script>

<script type="module">
    const stream = await navigator.mediaDevices.getUserMedia({
        video: {
            facingMode: 'environment',
        }
    });

    import QrScanner from "./qr-scanner.min.js";

    var qrVideo = document.getElementById('qr-video');
    var qrCanvas = document.getElementById('qr-canvas');
    var context = qrCanvas.getContext('2d');
    var cw = 0;
    var ch = 0;

    qrVideo.addEventListener('play', function() {
        draw(this,context, qrCanvas);
    }, false);

    function draw(v,c) {
        if(v.paused || v.ended) return false;

        cw = qrCanvas.width;
        ch = qrCanvas.height;
        qrCanvas.style.width = qrVideo.offsetWidth + "px";
        qrCanvas.style.height = qrVideo.offsetHeight + "px";

        c.drawImage(v,0,0,parseInt(cw),parseInt(ch));
        setTimeout(draw,20,v,c);

        if (godotFunctions.update_camera != null) {
            godotFunctions.update_camera(qrCanvas.toDataURL());
        }
    }

    function setResult(result) {
        godotFunctions.update_qr(result.data);
    }

    // ####### Web Cam Scanning #######

    const scanner = new QrScanner(qrVideo, result => setResult(result), {
        onDecodeError: error => {},
        highlightScanRegion: false,
        highlightCodeOutline: false,
    });

    scanner.start().then(() => {
        // List cameras after the scanner started to avoid listCamera's stream and the scanner's stream being requested
        // at the same time which can result in listCamera's unconstrained stream also being offered to the scanner.
        // Note that we can also start the scanner after listCameras, we just have it this way around in the demo to
        // start the scanner earlier.
        // QrScanner.listCameras(true).then(cameras => cameras.forEach(camera => {
        //     const option = document.createElement('option');
        //     option.value = camera.id;
        //     option.text = camera.label;
        //     camList.add(option);
        // }));
    });
</script>
</body>
</html>